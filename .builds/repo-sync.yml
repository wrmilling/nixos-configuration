image: alpine/edge
secrets:
- 77fed647-474b-42fb-8693-a61317505286
sources:
- https://git.sr.ht/~wrmilling/nixos-configuration
environment:
  REPO: nixos-configuration
  BRANCH: main
tasks:
- push: |
    # Ensure we are on the main branch, exit build if not
    cd $REPO
    git diff -s --exit-code origin/${BRANCH} || complete-build

    # Ignore hosts keys, since we accept them as-is
    git config --global core.sshCommand 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'

    # Push copy of code to GitHub
    git remote add github git@github.com:wrmilling/${REPO}.git
    git push github $BRANCH

    # Push copy of code to Codeberg
    git remote add codeberg git@codeberg.org:wrmilling/${REPO}.git
    git push codeberg $BRANCH

    # Push copy of code to GitLab
    git remote add gitlab git@gitlab.com:wrmilling/${REPO}.git
    git push gitlab $BRANCH

    # Push copy of code to Homelab
    git remote add homelab git@git.homelab.tokyo:wrmilling/${REPO}.git
    git push homelab $BRANCH
